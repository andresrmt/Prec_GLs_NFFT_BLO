

# Associated data and code

The files in this code repository are commented versions of the code used for the following work:

_Efficient nonlocal linear image denoising: Bilevel optimisation with Nonequispaced Fast Fourier Transform and matrix-free preconditioning_ by Andr√©s Miniguano-Trujillo, John Pearson, Ben Goddard.

## Main files in this repository

* [`ReadMe.md`](README.md): This file.
* The [`Outputs`](Outputs) subfolder contains all the plots generated by each test except for figures 8 and 9.
* The [`Images`](Images) contains all the images used to test our proposed method, the scalings used, and the denoising outputs. The [`Catset`](Images/Catset) subfolder contains pictures of different cats kindly provided by Bernhard Heinzelreiter (Maxwell Institute for Mathematical Sciences), Jennifer Buchberger, Belen Santacruz Reyes, and Alejandro Saenz Ortega.

Jupyter notebooks with code for all the results are included.

1. Figure 2 compares the eigenvalues of the original and preconditioned systems as well as the resulting condition number for different values of $\sigma$. 
See notebook [`Eigs plots - Main.ipynb`](Eigs%20plots%20-%20Main.ipynb)
for the main panels, [`Eigs plots - Small sigma.ipynb`](Eigs%20plots%20-%20Small%20sigma.ipynb) for an additional computational study when $\sigma < 10$, and [`Eig plots - Several images.ipynb`](Eig%20plots%20-%20Several%20images.ipynb) for a test on the computational bounds around the spectra.

2. Figure 3 compares the eigenvalues of $\mathsf{P}^{-1}_{\mathsf{a}} A$ and $\mathsf{P}^{-1}_{\mathsf{b}} A$ for $\lambda = 10^{-9}$. 
See notebook [`Eigs plots - Main.ipynb`](Eigs%20plots%20-%20Main.ipynb).

3. Figure 3 compares the eigenvalues of $\mathsf{P}^{-1}_{\mathsf{a}} A$, $\pi_2 ( \mathsf{D}^{-1}_{\mathsf{a},\, X} \mathsf{A}_X)$, $\mathsf{P}^{-1}_{\mathsf{b}} A$, and $\pi_2 ( \mathsf{D}^{-1}_{\mathsf{b},\, X} \mathsf{A}_X)$. for $\lambda = 10^{-9}$. 
See notebook [`Eigs plots - Main.ipynb`](Eigs%20plots%20-%20Main.ipynb).

4. Table 1 is a time comparison of setting up a kernel via a NFFT--based fast summation method versus computing the kernel exactly as the dimension grows. 
See notebook [`Size times.ipynb`](Size%20times.ipynb)

5. Table 2 is a time comparison for solving the nonlocal system without preconditioning, where the nonlocal operator \(\Gamma\) is either given by the NFFT--based fast summation method or by exact kernel computation. 
See notebook [`Unprec solve times.ipynb`](Unprec%20solve%20times.ipynb).

6. Table 6 displays the number of CG iterations for different regularisation values and each choice of preconditioner when solving the nonlocal system via the NFFT--based fast summation method. 
See notebook [`CG - All preconditioners.ipynb`](http://localhost:8889/notebooks/CG%20-%20All%20preconditioners.ipynb).

7. Figure 7 is a comparative display of the number of CG iterations for different regularisation values $\lambda \in \Lambda$ and each choice of preconditioner.
See notebook [`CG - All preconditioners.ipynb`](http://localhost:8889/notebooks/CG%20-%20All%20preconditioners.ipynb).
The selected image corresponds to $n=775$ as it showcases many methods still working for not too small $\lambda$. 
A fully reproducible version is presented in [`CG - All preconditioners - Repr & Chol`](CG%20-%20All%20preconditioners%20-%20Repr%20%26%20Chol.ipynb), which also contains a test for the randomised pivoted Cholesky approximation as a preconditioner. [üëÅÔ∏è‚Äçüó®Ô∏è]

8. Figures 8 and 9 display the results of the batch training using bilevel optimisation on the included dataset.
See notebook [`Scalar Training - ParaCats.ipynb`](8%20Scalar%20Training%20-%20ParaCats.ipynb). [üëÅÔ∏è‚Äçüó®Ô∏è]

9. Joint parameter optimisation (both $\lambda$ and $h = \sigma^{-2}$) is performed for improved quality in [Bilevel_2_Params - ParaCats](Bilevel_2_Params%20-%20ParaCats.ipynb). [üëÅÔ∏è‚Äçüó®Ô∏è]

---
## Dependencies

The original code used the following standard libraries:
`NumPy 1.23.0`, `Pandas 1.4.2`, `SciPy 1.11.1`.

The notebooks with a [üëÅÔ∏è‚Äçüó®Ô∏è] marker were adapted to
`NumPy 1.26.4`, `Pandas 2.2.3`, `SciPy 1.15.1` 



A copy of the [`NFFT4ANOVA`](NFFT4ANOVA) library by Theresa Wagner (TU Chemnitz) is included in the folder. It depends on the [`FastAdjacency`](https://github.com/dominikbuenger/FastAdjacency) package by Dominik Alfke and the Julia interface of the [`NFFT3`](https://www-user.tu-chemnitz.de/~potts/nfft/) library. Refer to [`FastAdjacency`](https://github.com/dominikbuenger/FastAdjacency) for a comprehensive set of installation instructions.

In [`CG - All preconditioners - Repr & Chol`](CG%20-%20All%20preconditioners%20-%20Repr%20%26%20Chol.ipynb), a copy of `rpcholesky` and `accelerated_rpcholesky` was adapted from the [`Randomly Pivoted Cholesky`](
https://github.com/eepperly/Randomly-Pivoted-Cholesky/tree/main) library by Yifan Chen, Ethan N. Epperly, Joel A. Tropp, and Robert J. Webber. Details on the algorithms are available in [[1]](https://doi.org/10.1002/cpa.22234) and [[2]](https://doi.org/10.48550/arXiv.2410.03969).



For better visualisation of the notebooks, the **codefolding for Jupyter** [extension](https://jupyter-contrib-nbextensions.readthedocs.io/en/latest/) is recommended.




